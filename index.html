<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Poison Roulette - Multi-Stat Edition</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #1a1a2e, #16213e, #0f0f23);
        color: #fff;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
      }

      .game-container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        padding: 30px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      h1 {
        text-align: center;
        font-size: 1.8em;
        margin-bottom: 20px;
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .players-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .player {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        cursor: pointer;
      }

      .player.alive {
        border-color: #4ecdc4;
        box-shadow: 0 0 20px rgba(78, 205, 196, 0.3);
      }

      .player.eliminated {
        background: rgba(255, 107, 107, 0.2);
        border-color: #ff6b6b;
        opacity: 0.7;
      }

      .player.current-turn {
        border-color: #ffd93d;
        box-shadow: 0 0 30px rgba(255, 217, 61, 0.5);
        transform: scale(1.05);
      }

      .player-name {
        font-size: 1.3em;
        font-weight: bold;
        margin-bottom: 10px;
      }

      .health-bar {
        background: rgba(255, 255, 255, 0.2);
        height: 15px;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }

      .health-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff6b6b, #ffd93d, #4ecdc4);
        transition: width 0.5s ease;
      }

      .player-stats {
        display: none;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin: 15px 0 10px 0;
        font-size: 0.85em;
      }

      .player-stats.expanded {
        display: grid;
      }

      .player-stat {
        background: rgba(255, 255, 255, 0.1);
        padding: 6px;
        border-radius: 5px;
      }

      .expand-toggle {
        font-size: 0.8em;
        color: #aaa;
        margin-top: 5px;
      }

      .drinks-container {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 30px 0;
        flex-wrap: wrap;
      }

      .drink {
        width: 50px;
        height: 120px;
        background: linear-gradient(
          180deg,
          transparent 15%,
          #333 15%,
          #333 90%,
          #444 90%
        );
        border-radius: 8px 8px 15px 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        border: 2px solid #666;
      }

      .drink:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      }

      .drink.selected {
        border-color: #ffd93d;
        box-shadow: 0 0 20px rgba(255, 217, 61, 0.5);
        transform: translateY(-5px) scale(1.1);
      }

      .drink.neutralized {
        border-color: #74b9ff;
        box-shadow: 0 0 15px rgba(116, 185, 255, 0.5);
      }

      .drink.spiked {
        border-color: #ff6b6b;
        box-shadow: 0 0 15px rgba(255, 107, 107, 0.5);
      }

      .drink-liquid {
        position: absolute;
        bottom: 6px;
        left: 6px;
        right: 6px;
        height: 70%;
        border-radius: 0 0 12px 12px;
        opacity: 0.9;
      }

      .drink.blue .drink-liquid {
        background: linear-gradient(180deg, #74b9ff, #0984e3);
      }

      .drink.green .drink-liquid {
        background: linear-gradient(180deg, #00b894, #00a085);
      }

      .drink.yellow .drink-liquid {
        background: linear-gradient(180deg, #fdcb6e, #e17055);
      }

      .drink.red .drink-liquid {
        background: linear-gradient(180deg, #ff6b6b, #d63031);
      }

      .drink.purple .drink-liquid {
        background: linear-gradient(180deg, #a29bfe, #6c5ce7);
      }

      .drink.black .drink-liquid {
        background: linear-gradient(180deg, #636e72, #2d3436);
      }

      .controls {
        text-align: center;
        margin: 20px 0;
      }

      .btn {
        background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
        border: none;
        color: white;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 1.1em;
        cursor: pointer;
        margin: 10px;
        transition: all 0.3s ease;
        font-weight: bold;
        text-transform: uppercase;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn.secondary {
        background: linear-gradient(45deg, #74b9ff, #0984e3);
        font-size: 0.9em;
        padding: 10px 20px;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background: linear-gradient(135deg, #2d3436, #636e72);
        margin: 10% auto;
        padding: 30px;
        border-radius: 20px;
        width: 80%;
        max-width: 600px;
        position: relative;
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 20px;
        top: 15px;
      }

      .close:hover {
        color: #fff;
      }

      .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .action-btn {
        background: linear-gradient(45deg, #ffd93d, #fdcb6e);
        border: none;
        color: #333;
        padding: 15px 20px;
        border-radius: 15px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        text-align: center;
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      }

      .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .turn-order {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        text-align: center;
      }

      .turn-order h3 {
        margin: 0 0 10px 0;
        color: #ffd93d;
        font-size: 1.1em;
      }

      .game-log {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        padding: 20px;
        height: 180px;
        overflow-y: auto;
        margin-top: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #4ecdc4;
        padding-left: 10px;
        font-size: 0.9em;
      }

      .log-entry.danger {
        border-left-color: #ff6b6b;
        color: #ff6b6b;
      }

      .log-entry.heal {
        border-left-color: #4ecdc4;
        color: #4ecdc4;
      }

      .log-entry.action {
        border-left-color: #ffd93d;
        color: #ffd93d;
      }

      .winner-announcement {
        text-align: center;
        font-size: 2em;
        color: #4ecdc4;
        background: rgba(78, 205, 196, 0.1);
        padding: 20px;
        border-radius: 15px;
        margin: 20px 0;
        border: 2px solid #4ecdc4;
        display: none;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      .pulse {
        animation: pulse 2s infinite;
      }

      .drink-legend {
        text-align: left;
        font-size: 0.9em;
      }

      .legend-row {
        margin: 10px 0;
        padding: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
      }

      .legend-title {
        font-weight: bold;
        margin-bottom: 15px;
        color: #ffd93d;
      }

      .help-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: linear-gradient(45deg, #74b9ff, #0984e3);
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .help-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <h1>☠️ Poison Roulette</h1>

      <div class="turn-order">
        <h3>Turn Order (Speed Based)</h3>
        <div id="turn-order-display"></div>
      </div>

      <div class="players-grid" id="players-grid">
        <!-- Players will be generated here -->
      </div>

      <div class="drinks-container" id="drinks-container">
        <!-- Drinks will be generated here -->
      </div>

      <div class="controls">
        <button class="btn" id="drink-btn" onclick="drinkSelected()" disabled>
          Drink Selected
        </button>
        <button
          class="btn"
          id="new-game-btn"
          onclick="startNewGame()"
          style="display: none"
        >
          New Game
        </button>
      </div>

      <div class="winner-announcement" id="winner-announcement">
        <div id="winner-text"></div>
      </div>

      <div class="game-log" id="game-log">
        <div class="log-entry">
          Multi-stat game started! Click players to see their stats...
        </div>
      </div>
    </div>

    <!-- Action Selection Modal -->
    <div id="action-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeActionModal()">&times;</span>
        <h3>🎯 Choose Your Action</h3>
        <div class="action-buttons" id="action-buttons">
          <!-- Action buttons will be generated here -->
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeHelpModal()">&times;</span>
        <div class="drink-legend">
          <div class="legend-title">Drink Effects Guide</div>

          <div class="legend-row">
            <span style="color: #74b9ff">🔵 Blue Elixir:</span> +5❤️ -2⚡ -1🔧
            (Safe but makes you slow and powerless)
          </div>

          <div class="legend-row">
            <span style="color: #00b894">🟢 Green Brew:</span> 70% chance for
            good effects (+15❤️ +1⚡ +1🔧), 30% mild poison (-8❤️ +2🔧 +1☠️)
          </div>

          <div class="legend-row">
            <span style="color: #fdcb6e">🟡 Yellow Mixture:</span> 50/50 gamble
            - either big boost (+20❤️ +2⚡) or painful lesson (-10❤️ +3🔧 +1☠️)
          </div>

          <div class="legend-row">
            <span style="color: #ff6b6b">🔴 Red Potion:</span> 30% heroic power
            (+25❤️ +1⚡ +1🛡️), 70% brutal punishment (-20❤️ +5🔧 +2☠️)
          </div>

          <div class="legend-row">
            <span style="color: #a29bfe">🟣 Purple Draught:</span> 25% mystical
            enhancement (+35❤️ +3⚡ +2🛡️), 75% cursed revenge (-25❤️ -1⚡ +8🔧
            +3☠️)
          </div>

          <div class="legend-row">
            <span style="color: #636e72">⚫ Black Essence:</span> 20% ultimate
            power (+40❤️ +4⚡ +3🛡️ + steal 10❤️), 80% near death (-35❤️ -2⚡
            +1🛡️ +12🔧 +4☠️)
          </div>

          <div
            style="
              margin-top: 20px;
              padding-top: 15px;
              border-top: 1px solid rgba(255, 255, 255, 0.2);
              font-size: 0.85em;
            "
          >
            <strong>Stats Explained:</strong><br />
            ❤️ Health | ⚡ Speed (turn order) | 🛡️ Shield (damage reduction) |
            🔧 Sabotage (action currency) | ☠️ Toxin (cumulative damage)
          </div>

          <div style="margin-top: 15px; font-size: 0.85em">
            <strong>Actions:</strong> Duplicate, Neutralize, Eliminate, Analyze,
            or Spike drinks using 🔧 Sabotage points
          </div>
        </div>
      </div>
    </div>

    <button class="help-btn" onclick="openHelpModal()">?</button>

    <script>
      let gameState = {
        players: [
          {
            name: "You",
            health: 100,
            speed: 0,
            shield: 0,
            sabotage: 0,
            toxin: 0,
            alive: true,
            isHuman: true,
          },
          {
            name: "AI Alpha",
            health: 100,
            speed: 0,
            shield: 0,
            sabotage: 0,
            toxin: 0,
            alive: true,
            isHuman: false,
          },
          {
            name: "AI Beta",
            health: 100,
            speed: 0,
            shield: 0,
            sabotage: 0,
            toxin: 0,
            alive: true,
            isHuman: false,
          },
          {
            name: "AI Gamma",
            health: 100,
            speed: 0,
            shield: 0,
            sabotage: 0,
            toxin: 0,
            alive: true,
            isHuman: false,
          },
        ],
        currentPlayerIndex: 0,
        round: 1,
        drinks: [],
        selectedDrink: null,
        gameOver: false,
        phase: "drinking",
        turnOrder: [],
      };

      const drinkEffects = {
        blue: {
          outcomes: [
            {
              chance: 100,
              health: 5,
              speed: -2,
              shield: 0,
              sabotage: -1,
              toxin: 0,
              description: "Safe but sluggish",
            },
          ],
        },
        green: {
          outcomes: [
            {
              chance: 70,
              health: 15,
              speed: 1,
              shield: 0,
              sabotage: 1,
              toxin: 0,
              description: "Refreshing boost!",
            },
            {
              chance: 30,
              health: -8,
              speed: 0,
              shield: 0,
              sabotage: 2,
              toxin: 1,
              description: "Mild poison, but you learned something",
            },
          ],
        },
        yellow: {
          outcomes: [
            {
              chance: 50,
              health: 20,
              speed: 2,
              shield: 0,
              sabotage: 0,
              toxin: 0,
              description: "Lucky break!",
            },
            {
              chance: 50,
              health: -10,
              speed: 0,
              shield: 0,
              sabotage: 3,
              toxin: 1,
              description: "Painful lesson",
            },
          ],
        },
        red: {
          outcomes: [
            {
              chance: 30,
              health: 25,
              speed: 1,
              shield: 1,
              sabotage: 0,
              toxin: 0,
              description: "Heroic power surge!",
            },
            {
              chance: 70,
              health: -20,
              speed: 0,
              shield: 0,
              sabotage: 5,
              toxin: 2,
              description: "Brutal but empowering",
            },
          ],
        },
        purple: {
          outcomes: [
            {
              chance: 25,
              health: 35,
              speed: 3,
              shield: 2,
              sabotage: 0,
              toxin: 0,
              description: "Mystical enhancement!",
            },
            {
              chance: 75,
              health: -25,
              speed: -1,
              shield: 0,
              sabotage: 8,
              toxin: 3,
              description: "Cursed but vengeful",
            },
          ],
        },
        black: {
          outcomes: [
            {
              chance: 20,
              health: 40,
              speed: 4,
              shield: 3,
              sabotage: 0,
              toxin: 0,
              description: "DEATH DEFIED! Ultimate power!",
              steal: 10,
            },
            {
              chance: 80,
              health: -35,
              speed: -2,
              shield: 1,
              sabotage: 12,
              toxin: 4,
              description: "Near death, but ultimate vengeance",
            },
          ],
        },
      };

      const actions = [
        {
          id: "duplicate",
          name: "Duplicate",
          cost: 2,
          description: "Create a copy of selected drink",
        },
        {
          id: "neutralize",
          name: "Neutralize",
          cost: 3,
          description: "Make drink give +5 health only",
        },
        {
          id: "eliminate",
          name: "Eliminate",
          cost: 2,
          description: "Remove drink from play",
        },
        {
          id: "analyze",
          name: "Analyze",
          cost: 4,
          description: "Reveal exact effects of drink",
        },
        {
          id: "spike",
          name: "Spike",
          cost: 3,
          description: "Add +15 damage to drink",
        },
      ];

      function initializeGame() {
        generateDrinks();
        updateTurnOrder();
        updateDisplay();
        startDrinkingPhase();
        logMessage(
          "Game started! Everyone begins with 0 action points - drink to earn them!"
        );
      }

      function generateDrinks() {
        gameState.drinks = [];
        const colors = ["blue", "green", "yellow", "red", "purple", "black"];

        for (let i = 0; i < 15; i++) {
          const color = colors[Math.floor(Math.random() * colors.length)];
          gameState.drinks.push({
            id: i,
            color: color,
            name: `${color.charAt(0).toUpperCase() + color.slice(1)} Elixir`,
            consumed: false,
            neutralized: false,
            spiked: false,
            analyzed: false,
            effects: null,
          });
        }
      }

      function updateTurnOrder() {
        gameState.turnOrder = gameState.players
          .filter((p) => p.alive)
          .sort((a, b) => b.speed - a.speed)
          .map((p) => p.name);

        const display = document.getElementById("turn-order-display");
        display.textContent = gameState.turnOrder.join(" → ");
      }

      function updateDisplay() {
        updatePlayers();
        updateDrinks();
        updateControls();
        updateTurnOrder();
      }

      function togglePlayerStats(playerIndex) {
        const statsDiv = document.querySelector(
          `#player-${playerIndex} .player-stats`
        );
        const toggleDiv = document.querySelector(
          `#player-${playerIndex} .expand-toggle`
        );

        if (statsDiv.classList.contains("expanded")) {
          statsDiv.classList.remove("expanded");
          toggleDiv.textContent = "Click to view stats ▼";
        } else {
          // Close all other expanded stats first
          document
            .querySelectorAll(".player-stats.expanded")
            .forEach((stats) => {
              stats.classList.remove("expanded");
            });
          document.querySelectorAll(".expand-toggle").forEach((toggle) => {
            toggle.textContent = "Click to view stats ▼";
          });

          // Open this one
          statsDiv.classList.add("expanded");
          toggleDiv.textContent = "Click to hide stats ▲";
        }
      }

      function updatePlayers() {
        const grid = document.getElementById("players-grid");
        grid.innerHTML = "";

        gameState.players.forEach((player, index) => {
          const playerDiv = document.createElement("div");
          playerDiv.id = `player-${index}`;
          playerDiv.className = `player ${
            player.alive ? "alive" : "eliminated"
          }`;
          playerDiv.onclick = () => togglePlayerStats(index);

          if (index === gameState.currentPlayerIndex && !gameState.gameOver) {
            playerDiv.classList.add("current-turn");
          }

          const healthPercentage = Math.max(0, Math.min(100, player.health));

          playerDiv.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    <div class="health-bar">
                        <div class="health-fill" style="width: ${healthPercentage}%"></div>
                    </div>
                    <div style="margin: 8px 0; font-size: 0.9em;">Health: ${
                      player.health
                    }</div>
                    <div class="player-stats">
                        <div class="player-stat">⚡ Speed: ${player.speed}</div>
                        <div class="player-stat">🛡️ Shield: ${
                          player.shield
                        }</div>
                        <div class="player-stat">🔧 Sabotage: ${
                          player.sabotage
                        }</div>
                        <div class="player-stat">☠️ Toxin: ${player.toxin}</div>
                    </div>
                    <div class="expand-toggle">Click to view stats ▼</div>
                    <div style="margin-top: 10px;">${
                      player.alive
                        ? index === gameState.currentPlayerIndex
                          ? "🎯 Active Turn"
                          : "⚡ Ready"
                        : "💀 Eliminated"
                    }</div>
                `;

          grid.appendChild(playerDiv);
        });
      }

      function updateDrinks() {
        const container = document.getElementById("drinks-container");
        container.innerHTML = "";

        gameState.drinks.forEach((drink) => {
          if (!drink.consumed) {
            const drinkDiv = document.createElement("div");
            let classes = `drink ${drink.color}`;
            if (drink.id === gameState.selectedDrink) classes += " selected";
            if (drink.neutralized) classes += " neutralized";
            if (drink.spiked) classes += " spiked";

            drinkDiv.className = classes;
            drinkDiv.onclick = () => selectDrink(drink.id);

            let tooltip = drink.name;
            if (drink.analyzed) {
              const effect = getRandomOutcome(drinkEffects[drink.color]);
              tooltip += `\n${effect.description}`;
            }
            if (drink.neutralized) tooltip += "\n(Neutralized - Safe)";
            if (drink.spiked) tooltip += "\n(Spiked - Extra Damage)";

            drinkDiv.title = tooltip;

            drinkDiv.innerHTML = `<div class="drink-liquid"></div>`;
            container.appendChild(drinkDiv);
          }
        });
      }

      function updateControls() {
        const drinkBtn = document.getElementById("drink-btn");
        const newGameBtn = document.getElementById("new-game-btn");

        const currentPlayer = gameState.players[gameState.currentPlayerIndex];
        const isHumanTurn =
          currentPlayer && currentPlayer.isHuman && currentPlayer.alive;

        // Show drink button if it's drinking phase, or action button if player has sabotage points
        if (isHumanTurn && currentPlayer.sabotage >= 2) {
          drinkBtn.textContent = "Use Action";
          drinkBtn.disabled =
            gameState.selectedDrink === null || gameState.gameOver;
        } else {
          drinkBtn.textContent = "Drink Selected";
          drinkBtn.disabled =
            !isHumanTurn ||
            gameState.selectedDrink === null ||
            gameState.gameOver;
        }

        newGameBtn.style.display = gameState.gameOver ? "inline-block" : "none";
      }

      function selectDrink(drinkId) {
        if (gameState.gameOver) return;

        gameState.selectedDrink = drinkId;
        updateDisplay();

        // If player has action points, show action modal
        const currentPlayer = gameState.players[gameState.currentPlayerIndex];
        if (
          currentPlayer &&
          currentPlayer.isHuman &&
          currentPlayer.sabotage >= 2
        ) {
          openActionModal();
        }
      }

      function openActionModal() {
        const modal = document.getElementById("action-modal");
        const actionButtons = document.getElementById("action-buttons");
        const currentPlayer = gameState.players[gameState.currentPlayerIndex];

        actionButtons.innerHTML = "";

        // Add "Just Drink" option
        const drinkButton = document.createElement("button");
        drinkButton.className = "action-btn";
        drinkButton.innerHTML = `<strong>Just Drink</strong><br>No cost<br><small>Drink the selected potion</small>`;
        drinkButton.onclick = () => {
          closeActionModal();
          drinkSelected();
        };
        actionButtons.appendChild(drinkButton);

        // Add action options
        actions.forEach((action) => {
          const button = document.createElement("button");
          button.className = "action-btn";
          button.innerHTML = `<strong>${action.name}</strong><br>${action.cost} 🔧<br><small>${action.description}</small>`;
          button.disabled = currentPlayer.sabotage < action.cost;
          button.onclick = () => {
            performAction(action.id);
            closeActionModal();
          };
          actionButtons.appendChild(button);
        });

        modal.style.display = "block";
      }

      function closeActionModal() {
        document.getElementById("action-modal").style.display = "none";
      }

      function openHelpModal() {
        document.getElementById("help-modal").style.display = "block";
      }

      function closeHelpModal() {
        document.getElementById("help-modal").style.display = "none";
      }

      function startActionPhase() {
        gameState.phase = "action";
        gameState.currentPlayerIndex = 0;
        gameState.players.forEach((p) => (p.hasActed = false));

        const firstPlayer = gameState.players.find(
          (p) => p.name === gameState.turnOrder[0]
        );
        gameState.currentPlayerIndex = gameState.players.indexOf(firstPlayer);

        updateDisplay();

        if (!gameState.players[gameState.currentPlayerIndex].isHuman) {
          setTimeout(aiAction, 1000);
        }
      }

      function performAction(actionId) {
        const currentPlayer = gameState.players[gameState.currentPlayerIndex];
        const action = actions.find((a) => a.id === actionId);
        const drink = gameState.drinks.find(
          (d) => d.id === gameState.selectedDrink
        );

        if (!drink || currentPlayer.sabotage < action.cost) return;

        currentPlayer.sabotage -= action.cost;

        switch (actionId) {
          case "duplicate":
            const newDrink = { ...drink, id: gameState.drinks.length };
            gameState.drinks.push(newDrink);
            logMessage(
              `${currentPlayer.name} duplicated ${drink.name}!`,
              "action"
            );
            break;

          case "neutralize":
            drink.neutralized = true;
            logMessage(
              `${currentPlayer.name} neutralized ${drink.name}!`,
              "action"
            );
            break;

          case "eliminate":
            drink.consumed = true;
            logMessage(
              `${currentPlayer.name} eliminated ${drink.name}!`,
              "action"
            );
            break;

          case "analyze":
            drink.analyzed = true;
            logMessage(
              `${currentPlayer.name} analyzed ${drink.name}!`,
              "action"
            );
            break;

          case "spike":
            drink.spiked = true;
            logMessage(
              `${currentPlayer.name} spiked ${drink.name} with poison!`,
              "action"
            );
            break;
        }

        gameState.selectedDrink = null;
        nextTurn();
      }

      function nextActionTurn() {
        let nextIndex = -1;
        for (let i = 0; i < gameState.turnOrder.length; i++) {
          const playerName = gameState.turnOrder[i];
          const player = gameState.players.find((p) => p.name === playerName);
          if (player && player.alive && !player.hasActed) {
            nextIndex = gameState.players.indexOf(player);
            break;
          }
        }

        if (nextIndex === -1) {
          startDrinkingPhase();
          return;
        }

        gameState.currentPlayerIndex = nextIndex;
        updateDisplay();

        if (!gameState.players[gameState.currentPlayerIndex].isHuman) {
          setTimeout(aiAction, 1500);
        }
      }

      function aiAction() {
        const currentPlayer = gameState.players[gameState.currentPlayerIndex];
        if (!currentPlayer.alive || currentPlayer.hasActed) return;

        const availableDrinks = gameState.drinks.filter((d) => !d.consumed);
        if (availableDrinks.length === 0) {
          currentPlayer.hasActed = true;
          nextActionTurn();
          return;
        }

        const randomDrink =
          availableDrinks[Math.floor(Math.random() * availableDrinks.length)];
        gameState.selectedDrink = randomDrink.id;

        const affordableActions = actions.filter(
          (a) => currentPlayer.sabotage >= a.cost
        );

        if (affordableActions.length === 0 || Math.random() < 0.3) {
          currentPlayer.hasActed = true;
          gameState.selectedDrink = null;
          nextActionTurn();
        } else {
          const chosenAction =
            affordableActions[
              Math.floor(Math.random() * affordableActions.length)
            ];
          performAction(chosenAction.id);
        }
      }

      function startDrinkingPhase() {
        gameState.phase = "drinking";
        gameState.currentPlayerIndex = 0;

        // Set current player to first in turn order
        const firstPlayer = gameState.players.find(
          (p) => p.name === gameState.turnOrder[0]
        );
        gameState.currentPlayerIndex = gameState.players.indexOf(firstPlayer);

        updateDisplay();

        if (!gameState.players[gameState.currentPlayerIndex].isHuman) {
          setTimeout(aiTurn, 1000);
        }
      }

      function drinkSelected() {
        if (gameState.selectedDrink === null || gameState.gameOver) return;

        const drink = gameState.drinks.find(
          (d) => d.id === gameState.selectedDrink
        );
        const currentPlayer = gameState.players[gameState.currentPlayerIndex];

        processDrink(currentPlayer, drink);
        nextTurn();
      }

      function processDrink(player, drink) {
        drink.consumed = true;

        let outcome;
        if (drink.neutralized) {
          outcome = {
            health: 5,
            speed: 0,
            shield: 0,
            sabotage: 0,
            toxin: 0,
            description: "Neutralized - safe",
          };
        } else {
          outcome = getRandomOutcome(drinkEffects[drink.color]);
          if (drink.spiked) {
            outcome.health -= 15;
          }
        }

        const oldHealth = player.health;
        player.health = Math.max(
          0,
          Math.min(100, player.health + outcome.health)
        );
        player.speed = Math.max(-10, player.speed + outcome.speed);
        player.shield = Math.max(0, player.shield + outcome.shield);
        player.sabotage = Math.max(0, player.sabotage + outcome.sabotage);
        player.toxin = Math.max(0, player.toxin + outcome.toxin);

        if (outcome.health < 0 && player.shield > 0) {
          const damageReduced = Math.min(
            Math.abs(outcome.health),
            player.shield * 5
          );
          player.health = Math.min(100, player.health + damageReduced);
          player.shield = Math.max(
            0,
            player.shield - Math.ceil(damageReduced / 5)
          );
        }

        if (outcome.steal) {
          gameState.players.forEach((p) => {
            if (p !== player && p.alive) {
              p.health = Math.max(0, p.health - outcome.steal);
            }
          });
        }

        if (player.health <= 0) {
          player.alive = false;
        }

        let logClass = outcome.health < 0 ? "danger" : "heal";
        logMessage(
          `${player.name} drank ${drink.name}! ${outcome.description}`,
          logClass
        );

        gameState.selectedDrink = null;
      }

      function getRandomOutcome(drinkEffect) {
        const random = Math.random() * 100;
        let cumulative = 0;

        for (const outcome of drinkEffect.outcomes) {
          cumulative += outcome.chance;
          if (random <= cumulative) {
            return outcome;
          }
        }
        return drinkEffect.outcomes[0];
      }

      function aiTurn() {
        const currentPlayer = gameState.players[gameState.currentPlayerIndex];
        if (!currentPlayer.alive || gameState.gameOver) return;

        const availableDrinks = gameState.drinks.filter((d) => !d.consumed);
        if (availableDrinks.length === 0) {
          nextTurn();
          return;
        }

        // AI decides whether to use action or drink
        const hasActionPoints = currentPlayer.sabotage >= 2;
        const shouldUseAction = hasActionPoints && Math.random() < 0.4; // 40% chance to use action if available

        const randomDrink =
          availableDrinks[Math.floor(Math.random() * availableDrinks.length)];
        gameState.selectedDrink = randomDrink.id;

        if (shouldUseAction) {
          // Use random action
          const affordableActions = actions.filter(
            (a) => currentPlayer.sabotage >= a.cost
          );
          if (affordableActions.length > 0) {
            const chosenAction =
              affordableActions[
                Math.floor(Math.random() * affordableActions.length)
              ];
            logMessage(
              `${currentPlayer.name} uses ${chosenAction.name} on ${randomDrink.name}!`,
              "action"
            );
            performAction(chosenAction.id);
            return;
          }
        }

        // Just drink
        logMessage(`${currentPlayer.name} drinks ${randomDrink.name}...`);
        processDrink(currentPlayer, randomDrink);
        setTimeout(nextTurn, 1000);
      }

      function getDrinkRiskScore(color, neutralized, spiked) {
        if (neutralized) return 0;

        const riskMap = {
          blue: 1,
          green: 2,
          yellow: 3,
          red: 4,
          purple: 5,
          black: 6,
        };
        let risk = riskMap[color] || 3;
        if (spiked) risk += 2;
        return risk;
      }

      function nextTurn() {
        // Apply toxin damage at end of turn
        const currentPlayer = gameState.players[gameState.currentPlayerIndex];
        if (currentPlayer.toxin > 0) {
          const toxinDamage = Math.floor(currentPlayer.toxin / 2);
          currentPlayer.health = Math.max(
            0,
            currentPlayer.health - toxinDamage
          );
          currentPlayer.toxin = Math.max(0, currentPlayer.toxin - 1);

          if (toxinDamage > 0) {
            logMessage(
              `${currentPlayer.name} takes ${toxinDamage} toxin damage!`,
              "danger"
            );
          }

          if (currentPlayer.health <= 0) {
            currentPlayer.alive = false;
          }
        }

        // Check win condition
        const alivePlayers = gameState.players.filter((p) => p.alive);
        if (alivePlayers.length <= 1) {
          endGame();
          return;
        }

        // Find next player in turn order
        let nextIndex = -1;
        const currentTurnIndex = gameState.turnOrder.indexOf(
          currentPlayer.name
        );

        for (let i = 1; i < gameState.turnOrder.length; i++) {
          const nextPlayerName =
            gameState.turnOrder[
              (currentTurnIndex + i) % gameState.turnOrder.length
            ];
          const nextPlayer = gameState.players.find(
            (p) => p.name === nextPlayerName
          );
          if (nextPlayer && nextPlayer.alive) {
            nextIndex = gameState.players.indexOf(nextPlayer);
            break;
          }
        }

        if (
          nextIndex === -1 ||
          nextIndex ===
            gameState.players.indexOf(
              gameState.players.find((p) => p.name === gameState.turnOrder[0])
            )
        ) {
          // Round complete
          gameState.round++;
          if (gameState.drinks.filter((d) => !d.consumed).length < 5) {
            generateDrinks();
            logMessage("New drinks prepared for the next round!");
          }

          // Reset to first player in turn order
          const firstPlayer = gameState.players.find(
            (p) => p.name === gameState.turnOrder[0]
          );
          gameState.currentPlayerIndex = gameState.players.indexOf(firstPlayer);
        } else {
          gameState.currentPlayerIndex = nextIndex;
        }

        updateDisplay();

        if (!gameState.players[gameState.currentPlayerIndex].isHuman) {
          setTimeout(aiTurn, 1500);
        }
      }

      function endGame() {
        gameState.gameOver = true;
        const alivePlayers = gameState.players.filter((p) => p.alive);
        const winnerDiv = document.getElementById("winner-announcement");
        const winnerText = document.getElementById("winner-text");

        if (alivePlayers.length === 1) {
          winnerText.textContent = `🏆 ${alivePlayers[0].name} WINS! 🏆`;
          logMessage(
            `Game Over! ${alivePlayers[0].name} mastered all stats and survived!`,
            "heal"
          );
        } else {
          winnerText.textContent = "💀 Total Elimination! 💀";
          logMessage("Game Over! Everyone has been eliminated!", "danger");
        }

        winnerDiv.style.display = "block";
        winnerDiv.classList.add("pulse");
        updateDisplay();
      }

      function startNewGame() {
        gameState = {
          players: [
            {
              name: "You",
              health: 100,
              speed: 0,
              shield: 0,
              sabotage: 0,
              toxin: 0,
              alive: true,
              isHuman: true,
            },
            {
              name: "AI Alpha",
              health: 100,
              speed: 0,
              shield: 0,
              sabotage: 0,
              toxin: 0,
              alive: true,
              isHuman: false,
            },
            {
              name: "AI Beta",
              health: 100,
              speed: 0,
              shield: 0,
              sabotage: 0,
              toxin: 0,
              alive: true,
              isHuman: false,
            },
            {
              name: "AI Gamma",
              health: 100,
              speed: 0,
              shield: 0,
              sabotage: 0,
              toxin: 0,
              alive: true,
              isHuman: false,
            },
          ],
          currentPlayerIndex: 0,
          round: 1,
          drinks: [],
          selectedDrink: null,
          gameOver: false,
          phase: "drinking",
          turnOrder: [],
        };

        document.getElementById("winner-announcement").style.display = "none";
        document.getElementById("game-log").innerHTML = "";
        closeHelpModal();
        initializeGame();
      }

      function logMessage(message, className = "") {
        const log = document.getElementById("game-log");
        const entry = document.createElement("div");
        entry.className = `log-entry ${className}`;
        entry.textContent = message;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
      }

      // Close modals when clicking outside
      window.onclick = function (event) {
        const actionModal = document.getElementById("action-modal");
        const helpModal = document.getElementById("help-modal");
        if (event.target === actionModal) {
          closeActionModal();
        }
        if (event.target === helpModal) {
          closeHelpModal();
        }
      };

      // Initialize the game
      initializeGame();
    </script>
  </body>
</html>
